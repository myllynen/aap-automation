# Ansible Automation Platform execution environments build definitions

ah_host: "{{ aap_hostname }}"
ee_ah_host: "{{ ah_host }}"

ee_base_registry_username: "{{ aap_username }}"
ee_base_registry_password: "{{ aap_password }}"
ee_registry_username: "{{ aap_username }}"
ee_registry_password: "{{ aap_password }}"
ee_ah_token: "{{ hub_token }}"

ee_validate_certs: "{{ aap_validate_certs }}"

# https://ansible.readthedocs.io/projects/builder/en/stable/definition/
ee_version: 3
ee_build_arg_defaults:
  ANSIBLE_GALAXY_CLI_COLLECTION_OPTS: -vvv
  #ANSIBLE_GALAXY_CLI_COLLECTION_OPTS: --ignore-certs --no-deps --upgrade -vvv
  PKGMGR_PRESERVE_CACHE: always
#ee_builder_dir: /var/tmp/build
#ee_builder_dir_clean: false
ee_build_options:
  container_init:
    entrypoint: '["/opt/builder/bin/entrypoint"]'
    package_pip: ''
  package_manager_path: /usr/bin/microdnf
  # We can expect these being ok with AAP images
  skip_ansible_check: true
  skip_pip_install: true
ee_verbosity: 1

ee_aap_version: 2.6
ee_image_push: true
ee_squash: new
ee_prune_images: true
ee_update_base_images: true
ee_pull_collections_from_hub: true
ee_registry_dest: "{{ ah_host }}/custom"

ee_list:
  - name: custom-full-rhel9
    base_image: "{{ ee_ah_host }}/ee-supported-rhel9:latest"

    dependencies:
      # Must match Python version with pip in base image
      python_interpreter:
        package_system: python3.11
        python_path: /usr/bin/python3.11
      # Exclude everything we are not adding ourselves
      exclude:
        # This would only consider deps from these collections
        #all_from_collections:
        #  - ~^(?!community|infra|myllynen).*
        python:
          - ~^(?!fastapi|flask).*
        system:
          - ~^(?!iputils).*
      galaxy:
        collections:
          - community.general
          #- community.windows
          - infra.aap_configuration
          - myllynen.rhel_ansible_roles
          #- myllynen.windows_ansible_roles
      python:
        - fastapi
        - flask
      system:
        - iputils
        # Packages often needed for building deps
        #- gcc [platform:rpm]
        #- python3.11-devel [platform:rpm]
        #- python3.11-requests [platform:rpm]
        #- systemd-devel [platform:rpm]

    build_files:
      # ee_pull_collections_from_hub: true adds ansible.cfg
      - src: "{{ lookup('env', 'PWD') + '/ansible-ee.cfg' }}"
        dest: configs
      - src: "{{ lookup('env', 'PWD') + '/pip.conf' }}"
        dest: configs

    build_steps:
      prepend_base:
        - ADD _build/configs/pip.conf /etc/ansible/pip.conf
      prepend_galaxy:
        - ADD _build/configs/ansible.cfg /etc/ansible/ansible.cfg
      prepend_final:
        - ADD _build/configs/ansible-ee.cfg /etc/ansible/ansible.cfg
      append_final:
        - RUN rm -rf /etc/yum.repos.d/* /var/{cache,lib}/{dnf,yum} /etc/pip.conf

    tag: latest


# https://github.com/ansible/galaxy_collection/issues/329
#hub_ee_images:
#  - name: custom/test
#    state: absent

#hub_ee_repositories:
#  - name: custom/test
#    state: absent
