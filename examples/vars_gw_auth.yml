# Ansible Automation Platform gateway configuration - authentication

aap_configuration_secure_logging: false
gateway_authenticators_secure_logging: false
gateway_authenticator_maps_secure_logging: false

gateway_authenticators:
  - name: Local Database Authenticator
    order: 1
    type: ansible_base.authentication.authenticator_plugins.local
    slug: local-database-authenticator
    enabled: true
    create_objects: true
    remove_users: false
    configuration:
      fallback_authentication:
        - aap_gateway_api.authentication.fallbacks.controller

  - name: Microsoft Active Directory
    order: 2
    type: ansible_base.authentication.authenticator_plugins.ldap
    slug: microsoft-active-directory
    enabled: false
    create_objects: true
    remove_users: true
    configuration:
      SERVER_URI:
        - ldap://ad.example.com:389
      START_TLS: true
      #BIND_DN: "{{ aap_ad_bind_username }}"
      #BIND_PASSWORD: "{{ aap_ad_bind_password }}"
      CONNECTION_OPTIONS: {}
      # https://access.redhat.com/solutions/7093912
      GROUP_TYPE: ActiveDirectoryGroupType
      GROUP_TYPE_PARAMS:
        name_attr: cn
      GROUP_SEARCH:
        - ou=groups,ou=corp,dc=example,dc=com
        - SCOPE_SUBTREE
        - (objectClass=group)
      #USER_DN_TEMPLATE: sAMAccountName=%(user)s,ou=users,ou=corp,dc=example,dc=com
      USER_ATTR_MAP:
        first_name: givenName
        last_name: sn
        email: mail
      USER_SEARCH:
        -
          - ou=users,ou=corp,dc=example,dc=com
          - SCOPE_SUBTREE
          - (sAMAccountName=%(user)s)

  - name: Red Hat IdM
    order: 3
    type: ansible_base.authentication.authenticator_plugins.ldap
    slug: redhat-idm
    enabled: false
    create_objects: true
    remove_users: true
    configuration:
      SERVER_URI:
        - ldap://idm.example.com:389
      START_TLS: false
      #BIND_DN: "{{ aap_idm_bind_username }}"
      #BIND_PASSWORD: "{{ aap_idm_bind_password }}"
      CONNECTION_OPTIONS: {}
      GROUP_TYPE: PosixGroupType
      GROUP_TYPE_PARAMS:
        name_attr: cn
      GROUP_SEARCH:
        - cn=groups,cn=accounts,dc=example,dc=com
        - SCOPE_SUBTREE
        - (objectClass=posixgroup)
      #USER_DN_TEMPLATE: uid=%(user)s,cn=users,cn=accounts,dc=example,dc=com
      USER_ATTR_MAP:
        first_name: givenName
        last_name: sn
        email: mail
      USER_SEARCH:
        -
          - cn=users,cn=accounts,dc=example,dc=com
          - SCOPE_SUBTREE
          - (uid=%(user)s)

  - name: Keycloak
    order: 4
    type: ansible_base.authentication.authenticator_plugins.keycloak
    slug: keycloak-auth
    enabled: false
    create_objects: true
    remove_users: true
    configuration:
      ACCESS_TOKEN_URL: https://keycloak.example.com:8443/realms/aap/protocol/openid-connect/token
      AUTHORIZATION_URL: https://keycloak.example.com:8443/realms/aap/protocol/openid-connect/auth
      GROUPS_CLAIM: roles
      KEY: aapoidc
      PUBLIC_KEY: "{{ aap_keycloak_public_key | default('changeme') }}"
      SECRET: "{{ aap_keycloak_secret | default('changeme') }}"

# AD/LDAP mapping example
# See vars_access_orgs.yml and vars_access_teams.yml
gateway_authenticator_maps:
  - name: AAP - Require access group membership
    authenticator: Microsoft Active Directory
    map_type: allow
    revoke: true
    order: 1
    triggers:
      groups:
        has_and:
          - cn=aap-access,ou=groups,ou=corp,dc=example,dc=com

  - name: AAP - Grant superuser permissions
    authenticator: Microsoft Active Directory
    map_type: is_superuser
    revoke: true
    order: 2
    triggers:
      groups:
        has_and:
          - cn=aap-admins,ou=groups,ou=corp,dc=example,dc=com

  - name: AAP - Grant platform auditor permissions
    authenticator: Microsoft Active Directory
    map_type: role
    role: Platform Auditor
    revoke: true
    order: 3
    triggers:
      groups:
        has_and:
          - cn=aap-auditors,ou=groups,ou=corp,dc=example,dc=com

  - name: Test Org - Assign organization members
    authenticator: Microsoft Active Directory
    map_type: organization
    role: Organization Member
    organization: Test Org
    revoke: true
    order: 4
    triggers:
      groups:
        has_or:
          - cn=test-org-admins,ou=groups,ou=corp,dc=example,dc=com
          - cn=test-org-auditors,ou=groups,ou=corp,dc=example,dc=com
          - cn=test-org-operators,ou=groups,ou=corp,dc=example,dc=com
          - cn=test-org-developers,ou=groups,ou=corp,dc=example,dc=com

  - name: Test Org - Grant organization admin permissions
    authenticator: Microsoft Active Directory
    map_type: organization
    role: Organization Admin
    organization: Test Org
    revoke: true
    order: 5
    triggers:
      groups:
        has_and:
          - cn=test-org-admins,ou=groups,ou=corp,dc=example,dc=com

  - name: Test Org - Assign team members - auditors
    authenticator: Microsoft Active Directory
    map_type: team
    role: Team Member
    organization: Test Org
    team: t_auditors
    revoke: true
    order: 6
    triggers:
      groups:
        has_and:
          - cn=test-org-auditors,ou=groups,ou=corp,dc=example,dc=com

  - name: Test Org - Assign team members - operators
    authenticator: Microsoft Active Directory
    map_type: team
    role: Team Member
    organization: Test Org
    team: t_operators
    revoke: true
    order: 7
    triggers:
      groups:
        has_and:
          - cn=test-org-operators,ou=groups,ou=corp,dc=example,dc=com

  - name: Test Org - Assign team members - developers
    authenticator: Microsoft Active Directory
    map_type: team
    role: Team Member
    organization: Test Org
    team: t_developers
    revoke: true
    order: 8
    triggers:
      groups:
        has_and:
          - cn=test-org-developers,ou=groups,ou=corp,dc=example,dc=com
